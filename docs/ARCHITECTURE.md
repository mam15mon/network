# 系统架构文档

## 概述

Nornir Network Management System 是一个基于现代 Python 技术栈的网络自动化管理平台，采用微服务架构设计，支持高并发、可扩展的网络设备管理。

## 技术架构

### 核心技术栈

- **Python 3.14.2**: 编程语言
- **FastAPI**: Web 框架和 API 服务
- **Nornir 3.5.0**: 网络自动化框架
- **Scrapli**: 高性能网络设备连接库
- **PostgreSQL**: 主数据库
- **SQLAlchemy**: ORM 框架
- **AsyncPG**: 异步 PostgreSQL 驱动
- **uv**: 现代 Python 包管理器

### 架构层次

```
┌─────────────────────────────────────────────────────────────┐
│                        API Layer                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ Device API  │  │ Task API    │  │Inventory API│         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                     Service Layer                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Nornir Manager                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │   │
│  │  │ Command     │  │ Config      │  │ Facts       │ │   │
│  │  │ Execution   │  │ Management  │  │ Collection  │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘ │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    Inventory Layer                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │            PostgreSQL Inventory Plugin               │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │   │
│  │  │   Device    │  │    Group    │  │   Default   │ │   │
│  │  │   Table     │  │   Table     │  │   Config    │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘ │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    Data Layer                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                PostgreSQL Database                   │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │   │
│  │  │   Devices   │  │    Tasks    │  │    Logs     │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘ │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. FastAPI 应用 (backend/main.py)

- **职责**: 提供 RESTful API 接口
- **特性**:
  - 自动 API 文档生成
  - 异步请求处理
  - 依赖注入
  - 中间件支持

### 2. Nornir 管理器 (app/services/nornir_manager.py)

- **职责**: 管理网络设备连接和任务执行
- **功能**:
  - 设备库存管理
  - 命令执行
  - 配置管理
  - 事实收集
  - 连接测试

### 3. PostgreSQL 库存插件 (inventory_plugin/postgres_inventory.py)

- **职责**: 从数据库加载设备信息到 Nornir
- **特性**:
  - 异步数据库操作
  - 动态库存更新
  - 分组和默认配置支持

### 4. 数据模型 (app/models/database.py)

- **职责**: 定义数据库表结构
- **主要表**:
  - `devices`: 设备信息
  - `device_groups`: 设备分组
  - `device_defaults`: 默认配置
  - `tasks`: 任务记录
  - `task_logs`: 任务日志

## 数据流

### 1. 设备发现流程

```
Client API Request → FastAPI → Nornir Manager → PostgreSQL Plugin → Database → Response
```

### 2. 命令执行流程

```
API Request → Task Creation → Nornir Manager → Scrapli → Network Device → Result Storage → Response
```

### 3. 配置管理流程

```
Config Request → Validation → Task Queue → Nornir → Scrapli Config → Device → Backup → Result
```

## 并发处理

### 异步架构

- **FastAPI**: 原生异步支持
- **AsyncPG**: 异步数据库操作
- **Nornir**: 多线程执行器
- **Scrapli**: 异步连接池

### 性能优化

- **连接池**: 数据库和设备连接复用
- **缓存**: 库存信息缓存
- **批量操作**: 支持多设备并行操作
- **队列系统**: 任务队列管理

## 安全设计

### 1. 认证和授权

- JWT Token 认证
- 基于角色的访问控制 (RBAC)
- API 密钥管理

### 2. 数据安全

- 密码加密存储
- 连接参数保护
- 审计日志记录

### 3. 网络安全

- TLS/SSL 加密
- SSH 密钥认证
- 网络隔离支持

## 扩展性设计

### 1. 水平扩展

- 微服务架构
- 负载均衡支持
- 分布式任务队列

### 2. 插件系统

- 自定义库存插件
- 任务插件接口
- 通知插件

### 3. API 版本控制

- URL 版本控制
- 向后兼容性
- 弃用策略

## 监控和日志

### 1. 应用监控

- 健康检查端点
- 性能指标收集
- 错误率监控

### 2. 日志系统

- 结构化日志
- 日志级别控制
- 日志轮转

### 3. 审计追踪

- 操作日志记录
- 用户行为追踪
- 变更历史

## 部署架构

### 1. 开发环境

```
Docker Compose:
- FastAPI App
- PostgreSQL
- Redis (可选)
```

### 2. 生产环境

```
Kubernetes:
- API Pods (多实例)
- PostgreSQL Cluster
- Redis Cluster
- Load Balancer
```

### 3. 容器化

- 多阶段构建
- 最小化镜像
- 安全扫描

## 配置管理

### 1. 环境配置

- 环境变量
- 配置文件
- 密钥管理

### 2. 动态配置

- 热重载支持
- 配置验证
- 默认值管理

## 错误处理

### 1. 异常处理

- 全局异常处理器
- 自定义异常类
- 错误响应格式

### 2. 重试机制

- 指数退避
- 最大重试次数
- 断路器模式

## 测试策略

### 1. 单元测试

- pytest 框架
- 模拟对象
- 覆盖率报告

### 2. 集成测试

- API 测试
- 数据库测试
- 设备模拟

### 3. 性能测试

- 负载测试
- 压力测试
- 基准测试

## 未来扩展

### 1. 功能扩展

- Web UI 界面
- 实时监控
- 自动化工作流

### 2. 技术升级

- GraphQL 支持
- WebSocket 实时通信
- 机器学习集成

### 3. 生态集成

- 监控系统集成
- CMDB 集成
- 云平台支持